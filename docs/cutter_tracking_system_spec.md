# Информационная система учёта резцов — спецификация

## 1. Назначение
Система предназначена для учёта экземпляров резцов, контроля эксплуатации, истории установок на станки, переточек и списаний. Основная цель — в любой момент понимать, где находится резец, сколько и где он работал, сколько раз точился, его текущий радиус и статус, а также упростить замену резцов на станках.

## 2. Основные сущности

### 2.1 Резец (экземпляр)
Резец — это конкретный физический инструмент (не тип). Для каждого резца хранится:
- полный серийный номер (уникальный, неизменяемый),
- сокращённый номер (уникальный, используется для поиска и отображения),
- дата ввода в эксплуатацию,
- дата и причина списания (если списан),
- статус,
- текущий радиус,
- количество переточек,
- описание/комментарии,
- текущее местонахождение.

Возможные местонахождения:
- на складе,
- в работе (установлен на станке),
- ожидает переточку,
- на переточке,
- списан.

### 2.2 История установок резца
Для каждого резца ведётся история установок на станки. Каждая установка содержит:
- дату установки,
- станок,
- tool post,
- дату снятия (если уже снят),
- причину снятия,
- вычисляемое количество дней в работе.

В один момент времени резец может быть установлен только на одном tool post одного станка.

### 2.3 Переточки
Для каждого резца ведётся история переточек. Каждая переточка содержит:
- дату переточки,
- радиус до переточки,
- радиус после переточки,
- вычисляемое количество дней между переточками,
- комментарий (опционально).

После добавления переточки:
- увеличивается счётчик переточек,
- обновляется текущий радиус резца.

## 3. Страницы системы

### 3.1 Реестр резцов
**Отображение**
- таблица со всеми резцами,
- колонки: сокращённый номер, статус + местонахождение, текущий радиус, дата ввода в эксплуатацию, кнопки быстрых действий,
- сортировка, фильтрация, поиск по сокращённому номеру.

**Быстрые действия**
- минимум: списание резца,
- возможные будущие: переточка, перемещение, замена.

### 3.2 Карточка резца
**Отображаемая информация**
- сокращённый и полный серийный номера,
- статус и местонахождение,
- текущий радиус,
- дата ввода в эксплуатацию,
- дата и причина списания (если списан),
- описание/комментарии.

**История переточек**
- дата переточки,
- предыдущий радиус,
- новый радиус,
- количество дней между переточками.

**История установок**
- дата установки,
- станок,
- tool post,
- дата снятия,
- количество дней в работе.

### 3.3 Замена резцов
**Отображение**
- карточки станков,
- в каждой карточке: наименование станка и список tool post,
- для каждого tool post: текущий установленный резец и дни в работе.

**Замена резца**
При выборе резца/tool post:
- открывается операция замены,
- текущая установка закрывается,
- выбирается новый резец,
- фиксируется история установки.

## 4. Логика и ограничения
- Резец со статусом «в работе» не может быть списан без снятия со станка.
- В одном tool post может быть установлен только один резец.
- Один резец не может быть установлен более чем в одном месте одновременно.
- Количество дней в работе и между переточками вычисляется автоматически.
- История установок и переточек не редактируется напрямую, только через операции.

## 5. Будущее развитие (не в MVP)
- справочник станков и tool posts,
- дополнительные статусы и причины снятия/списания,
- отчёты (наработка, частота переточек, ресурс),
- роли пользователей и аудит действий,
- уведомления (переработка, пора точить, пора списывать).

## 6. Принципы
- ничего не удаляется физически, только переводится в статус,
- ключевые изменения фиксируются в истории,
- система должна отвечать на вопрос: «Где сейчас этот резец и что с ним было раньше?»

## 7. Сущности и связи (высокий уровень)
**Основные:**
- cutters — резцы (экземпляры),
- machines — станки,
- tool_posts — tool post’ы станков,
- installations — установки резцов (история),
- resharpenings — переточки (история).

**Справочники/служебные:**
- cutter_statuses (или enum) — статусы резца,
- removal_reasons — причины снятия,
- scrap_reasons — причины списания,
- users — пользователи (если потребуется авторство действий),
- audit_log — журнал действий (опционально).

**Снимки для скорости (опционально):**
- cutter_current_location или поля в cutters,
- tool_post_current_cutter или materialized view.

## 8. Схема данных (черновой уровень)

### 8.1 cutters — резцы
Поля:
- id (PK),
- serial_full (unique, not null),
- serial_short (unique, not null),
- commissioned_at (not null),
- status (not null),
- radius_current (not null),
- resharpen_count (not null default 0),
- scrapped_at (nullable),
- scrap_reason_id (FK),
- description (nullable),
- location_type (not null),
- location_machine_id (FK, nullable),
- location_tool_post_id (FK, nullable),
- location_note (nullable),
- created_at, updated_at, created_by, updated_by.

Проверки/ограничения:
- serial_full UNIQUE,
- serial_short UNIQUE,
- status = scrapped → scrapped_at и scrap_reason_id обязательны,
- location_type = machine → location_machine_id и location_tool_post_id обязательны,
- location_type != machine → location_tool_post_id NULL.

Индексы:
- по serial_short, status, location_type/machine/tool_post, commissioned_at.

### 8.2 machines — станки
- id (PK),
- name (not null),
- code (unique, nullable),
- is_active (default true),
- created_at, updated_at.

### 8.3 tool_posts — tool post’ы
- id (PK),
- machine_id (FK),
- name (not null),
- position (nullable),
- is_active (default true),
- created_at, updated_at.

Ограничения:
- UNIQUE(machine_id, name),
- опционально UNIQUE(machine_id, position).

### 8.4 installations — история установок
- id (PK),
- cutter_id (FK),
- machine_id (FK),
- tool_post_id (FK),
- installed_at (not null),
- removed_at (nullable),
- removal_reason_id (FK, nullable),
- comment (nullable),
- created_by (FK, nullable),
- created_at (default now).

Ключевые ограничения:
- один активный резец: уникальность cutter_id при removed_at IS NULL,
- один резец на tool post: уникальность tool_post_id при removed_at IS NULL,
- removed_at >= installed_at.

### 8.5 resharpenings — история переточек
- id (PK),
- cutter_id (FK),
- sharpened_at (not null),
- radius_before (not null),
- radius_after (not null),
- comment (nullable),
- created_by (FK, nullable),
- created_at (default now).

Ограничения:
- radius_before > 0, radius_after > 0,
- опционально radius_after <= radius_before.

### 8.6 справочники
- scrap_reasons(id, code unique, name, is_active),
- removal_reasons(id, code unique, name, is_active),
- cutter_statuses (если не enum).

## 9. Получение текущих данных

### 9.1 Реестр резцов
Берётся напрямую из cutters: serial_short, status, location, radius_current, commissioned_at.

### 9.2 Карточка резца
- установки: installations по cutter_id, сортировка по installed_at DESC,
- дни в работе: removed_at - installed_at, иначе now() - installed_at,
- переточки: resharpenings по cutter_id, сортировка по sharpened_at DESC,
- дни между переточками: оконные функции или вычисление в приложении.

### 9.3 Замена резцов
- текущие установки: installations с removed_at IS NULL.

## 10. Транзакционные правила операций

### 10.1 Установка/замена резца
1. Проверить: резец не scrapped, нет активной установки, tool_post свободен.
2. Создать installation с installed_at = now().
3. Обновить cutters: status = in_work, location_type = machine, location_machine_id и location_tool_post_id.

### 10.2 Снятие резца
1. Найти активную установку.
2. Проставить removed_at и причину/комментарий.
3. Обновить cutters: status/location в зависимости от результата (warehouse/awaiting_resharpen/in_resharpen).

### 10.3 Добавление переточки
1. Создать запись resharpenings.
2. Обновить cutters: radius_current, resharpen_count + 1, при необходимости статус/местонахождение.

### 10.4 Списание резца
1. Проверить отсутствие активной установки (или снять резец с фиксацией причины).
2. Обновить cutters: status = scrapped, scrapped_at, scrap_reason_id, location_type = scrapped.

## 11. Дополнения «на будущее»
- cutter_types (тип/номенклатура) с привязкой cutters.cutter_type_id,
- attachments (фото/чертежи) для сущностей.
